{{define "deployment-parameters"}}
<div class="card mb-4">
    <div class="card-header">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h2>Deployment Parameters</h2>
                <p class="card-description mb-0">Configure deployment settings for all services</p>
            </div>
            <div class="d-flex gap-2">
                <button type="submit" form="parameters-form" class="btn btn-sm" id="btn-save-parameters">SAVE</button>
                <button type="button" class="btn btn-sm btn-secondary" id="btn-reset-parameters">RESET</button>
            </div>
        </div>
    </div>
    
    <div class="card-body">
        <form id="parameters-form">
        <!-- Global Defaults Section -->
        <div class="mb-5 pb-4">
            <div class="d-flex justify-content-between align-items-start mb-3">
                <div>
                    <h3 class="mb-1">Global Defaults</h3>
                    <p class="small text-muted mb-0">Apply to all services unless overridden</p>
                </div>
                <button type="button" class="btn btn-sm btn-secondary" data-bs-toggle="collapse" data-bs-target="#global-advanced" aria-expanded="false" aria-controls="global-advanced">
                    <span class="toggle-text">SHOW MORE</span>
                </button>
            </div>
            
            <div id="global-params-form" class="row g-3">
                <!-- Form will be generated by JavaScript from JSON Schema -->
            </div>
        </div>
        
        <!-- Per-Service Overrides Section -->
        <div class="mb-0">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div>
                    <h3 class="mb-1">Service Overrides</h3>
                    <p class="small text-muted mb-0">Override defaults for specific services</p>
                </div>
            </div>
            
            <div class="row g-3">
                {{range .Services}}
                <div class="col-md-6">
                    <div class="service-override-card p-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <h4 class="mb-0 text-capitalize">{{.}}</h4>
                            <button type="button" class="btn btn-sm btn-secondary" data-bs-toggle="collapse" data-bs-target="#collapse-{{.}}" aria-expanded="false" aria-controls="collapse-{{.}}">
                                <span class="toggle-text">CONFIGURE</span>
                            </button>
                        </div>
                        
                        <div class="collapse" id="collapse-{{.}}">
                            <!-- Title Row -->
                            <div class="row g-3 mb-3">
                                <div class="col-12 col-lg-6">
                                    <h5 class="mb-0 small fw-bold text-uppercase">Override Values</h5>
                                </div>
                                <div class="col-12 col-lg-6">
                                    <h5 class="mb-0 small fw-bold text-uppercase d-flex align-items-center gap-2">
                                        <span>Current Values</span>
                                        <span id="current-values-badge-{{.}}" class="current-values-badge-inline"></span>
                                    </h5>
                                </div>
                            </div>
                            <!-- Content Row -->
                            <div class="row g-3">
                                <div class="col-12 col-lg-6">
                                    <div id="service-params-form-{{.}}" class="row g-3">
                                        <!-- Form will be generated by JavaScript from JSON Schema -->
                                    </div>
                                </div>
                                <div class="col-12 col-lg-6">
                                    <div id="current-values-{{.}}" class="current-values-panel">
                                        {{$serviceValues := ""}}
                                        {{if $.ServiceValues}}
                                            {{$serviceValues = index $.ServiceValues .}}
                                        {{end}}
                                        {{if $serviceValues}}
                                            {{$valuesToShow := $serviceValues.deployed | default $serviceValues.merged}}
                                            {{if $valuesToShow}}
                                                <div class="row g-3">
                                                    {{template "render-param-display-group" (dict "Params" $valuesToShow "Level" 0)}}
                                                </div>
                                            {{else}}
                                                <div class="current-values-empty">No values available</div>
                                            {{end}}
                                        {{else}}
                                            <div class="current-values-empty">Loading...</div>
                                        {{end}}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {{end}}
            </div>
        </div>
        
            <div id="parameters-status" class="mt-3"></div>
        </form>
    </div>
</div>

<!-- Confirmation Modal -->
<div class="modal fade" id="confirm-modal" tabindex="-1" aria-labelledby="confirm-modal-label" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content custom-modal">
            <div class="modal-header">
                <h5 class="modal-title" id="confirm-modal-label">Confirm Action</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p id="confirm-modal-message"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="confirm-modal-cancel" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn" id="confirm-modal-confirm">Confirm</button>
            </div>
        </div>
    </div>
</div>

<script>
    // Initialize JSON Schema Form Generator
    (function() {
        let crdSchema = null;
        let instanceData = {};
        try {
            const crdSchemaJson = {{if .CRDSchemaJSON}}{{.CRDSchemaJSON | safeJS}}{{else}}'null'{{end}};
            const instanceDataJson = {{if .InstanceSpecJSON}}{{.InstanceSpecJSON | safeJS}}{{else}}'{}'{{end}};
            if (crdSchemaJson && crdSchemaJson !== 'null' && typeof crdSchemaJson === 'string') {
                crdSchema = JSON.parse(crdSchemaJson);
            } else if (crdSchemaJson && typeof crdSchemaJson === 'object') {
                crdSchema = crdSchemaJson;
            }
            if (instanceDataJson && instanceDataJson !== '{}' && typeof instanceDataJson === 'string') {
                instanceData = JSON.parse(instanceDataJson);
            } else if (instanceDataJson && typeof instanceDataJson === 'object') {
                instanceData = instanceDataJson;
            }
        } catch (e) {
            console.error('Failed to parse schema or instance data:', e);
        }
        
        // Simple recursive form generator from JSON Schema
        function generateFormFromSchema(schema, data, prefix, container) {
            if (!schema || !schema.properties) return;
            
            Object.keys(schema.properties).forEach(key => {
                const prop = schema.properties[key];
                const value = data && data[key] !== undefined ? data[key] : (prop.default !== undefined ? prop.default : '');
                const fieldName = prefix ? `${prefix}.${key}` : key;
                const fieldId = fieldName.replace(/\./g, '-').replace(/\[/g, '-').replace(/\]/g, '');
                
                if (prop.type === 'object' && prop.properties) {
                    // Nested object - create collapsible section
                    const sectionDiv = document.createElement('div');
                    sectionDiv.className = 'col-12';
                    sectionDiv.innerHTML = `
                        <div class="border rounded p-3 mt-2">
                            <h6 class="mb-2 fw-bold">${key.charAt(0).toUpperCase() + key.slice(1)}</h6>
                            <div class="row g-3" id="${fieldId}-container"></div>
                        </div>
                    `;
                    container.appendChild(sectionDiv);
                    const nestedContainer = document.getElementById(`${fieldId}-container`);
                    generateFormFromSchema(prop, value || {}, fieldName, nestedContainer);
                } else if (prop.type === 'array') {
                    // Array type
                    const arrayDiv = document.createElement('div');
                    arrayDiv.className = 'col-12';
                    const items = value || [];
                    let arrayHtml = `<label for="${fieldId}" class="form-label fw-semibold small">${key.charAt(0).toUpperCase() + key.slice(1)}</label>`;
                    items.forEach((item, idx) => {
                        if (prop.items && prop.items.type === 'object') {
                            arrayHtml += `<div class="border rounded p-2 mb-2" id="${fieldId}-item-${idx}"></div>`;
                        } else {
                            arrayHtml += `<input type="text" class="form-control form-control-sm mb-2" name="${fieldName}[${idx}]" value="${item}" placeholder="">`;
                        }
                    });
                    arrayHtml += `<button type="button" class="btn btn-sm btn-secondary mt-2" onclick="addArrayItem('${fieldName}', '${fieldId}')">Add Item</button>`;
                    arrayDiv.innerHTML = arrayHtml;
                    container.appendChild(arrayDiv);
                } else {
                    // Primitive type
                    const inputDiv = document.createElement('div');
                    inputDiv.className = 'col-12';
                    let inputHtml = `<label for="${fieldId}" class="form-label fw-semibold small">${key.charAt(0).toUpperCase() + key.slice(1)}</label>`;
                    
                    if (prop.type === 'boolean') {
                        inputHtml += `<input type="checkbox" class="form-check-input" id="${fieldId}" name="${fieldName}" ${value ? 'checked' : ''}>`;
                    } else if (prop.type === 'number' || prop.type === 'integer') {
                        inputHtml += `<input type="number" class="form-control form-control-sm" id="${fieldId}" name="${fieldName}" value="${value}" step="${prop.type === 'integer' ? '1' : 'any'}">`;
                    } else {
                        inputHtml += `<input type="text" class="form-control form-control-sm" id="${fieldId}" name="${fieldName}" value="${value || ''}" placeholder="${prop.default || ''}">`;
                    }
                    
                    inputDiv.innerHTML = inputHtml;
                    container.appendChild(inputDiv);
                }
            });
        }
        
        // Generate global form
        // Note: crdSchema here is actually the spec schema (not the full CRD schema)
        // So we check for crdSchema.properties.global directly
        if (crdSchema && crdSchema.properties && crdSchema.properties.global) {
            const globalSchema = crdSchema.properties.global;
            const globalData = instanceData.global || {};
            const globalContainer = document.getElementById('global-params-form');
            if (globalContainer) {
                console.log('Generating global form with schema:', globalSchema, 'and data:', globalData);
                generateFormFromSchema(globalSchema, globalData, 'global', globalContainer);
            } else {
                console.error('Global container not found');
            }
        } else {
            console.error('Global schema not found in crdSchema:', crdSchema);
        }
        
        // Generate service forms
        const servicesJson = {{.Services | json | safeJS}};
        let services = [];
        try {
            if (typeof servicesJson === 'string') {
                services = JSON.parse(servicesJson);
            } else if (Array.isArray(servicesJson)) {
                services = servicesJson;
            } else {
                console.error('Services is not a string or array:', typeof servicesJson, servicesJson);
            }
        } catch (e) {
            console.error('Failed to parse services JSON:', e, servicesJson);
        }
        if (Array.isArray(services)) {
            services.forEach(serviceName => {
            const serviceContainer = document.getElementById(`service-params-form-${serviceName}`);
            // Note: crdSchema here is the spec schema, so check crdSchema.properties.services
            if (serviceContainer && crdSchema && crdSchema.properties && crdSchema.properties.services) {
                const servicesSchema = crdSchema.properties.services;
                // Services schema has additionalProperties, so we use it as a template
                if (servicesSchema.additionalProperties && servicesSchema.additionalProperties.properties) {
                    const serviceData = (instanceData.services && instanceData.services[serviceName]) || {};
                    generateFormFromSchema(servicesSchema.additionalProperties, serviceData, `services.${serviceName}`, serviceContainer);
                }
            }
        });
        } else {
            console.error('Services is not an array:', services);
        }
        
        // Helper function for adding array items
        window.addArrayItem = function(fieldName, fieldId) {
            // Simple implementation - just add an empty input
            const container = document.getElementById(fieldId).parentElement;
            const newInput = document.createElement('input');
            newInput.type = 'text';
            newInput.className = 'form-control form-control-sm mb-2';
            newInput.name = `${fieldName}[${container.querySelectorAll('input').length}]`;
            newInput.placeholder = 'Enter value';
            container.insertBefore(newInput, container.lastElementChild);
        };
    })();
</script>
<script>
(function() {
    // Load merged values for a specific service as fallback
    async function loadMergedValuesForService(serviceName) {
        try {
            const response = await fetch(`/api/parameters/${serviceName.toLowerCase()}`);
            if (response.ok) {
                const mergedParams = await response.json();
                const serviceData = { merged: mergedParams };
                updateCurrentValuesDisplay(serviceName, serviceData);
            }
        } catch (error) {
            console.error(`Error loading merged values for ${serviceName}:`, error);
        }
    }
    
    // Load current values for all services (for dynamic updates)
    // Note: Initial values are rendered server-side, this is mainly for refresh
    async function loadCurrentValues() {
        try {
            const response = await fetch('/api/parameters/values');
            if (!response.ok) {
                throw new Error('Failed to load current values');
            }
            const data = await response.json();
            
            // Update badges and refresh current values if needed
            // Create a normalized map (lowercase keys) for case-insensitive matching
            const normalizedData = {};
            for (const [serviceName, serviceData] of Object.entries(data)) {
                normalizedData[serviceName.toLowerCase()] = { serviceName, serviceData };
            }
            
            // Update badges for all services
            document.querySelectorAll('[id^="current-values-badge-"]').forEach(badgeEl => {
                const serviceName = badgeEl.id.replace('current-values-badge-', '');
                const normalizedKey = serviceName.toLowerCase();
                
                if (normalizedData[normalizedKey]) {
                    const serviceData = normalizedData[normalizedKey].serviceData;
                    const isDeployed = !!serviceData.deployed;
                    if (isDeployed) {
                        badgeEl.className = 'current-values-badge-inline current-values-badge-success';
                        badgeEl.textContent = 'Deployed';
                    } else {
                        badgeEl.className = 'current-values-badge-inline';
                        badgeEl.textContent = 'Default';
                    }
                }
            });
        } catch (error) {
            console.error('Error loading current values:', error);
        }
    }
    
    function updateCurrentValuesDisplay(serviceName, serviceData) {
        const container = document.getElementById(`current-values-${serviceName}`);
        if (!container) {
            console.warn(`Container not found for service: ${serviceName}`);
            return;
        }
        
        // Determine which values to show: deployed if available, otherwise merged/default
        const valuesToShow = serviceData.deployed || serviceData.merged;
        const isDeployed = !!serviceData.deployed;
        
        // Update badge in title first
        const badgeEl = document.getElementById(`current-values-badge-${serviceName}`);
        if (badgeEl) {
            if (isDeployed) {
                badgeEl.className = 'current-values-badge-inline current-values-badge-success';
                badgeEl.textContent = 'Deployed';
            } else {
                badgeEl.className = 'current-values-badge-inline';
                badgeEl.textContent = 'Default';
            }
        }
        
        if (!valuesToShow) {
            container.innerHTML = '<div class="current-values-empty">No values available</div>';
            return;
        }
        
        // Clear container completely before adding new content
        container.innerHTML = '';
        
        let html = '';
        html += '<div class="row g-3">';
        
        // Namespace - always show
        html += '<div class="col-12">';
        html += '<label class="form-label fw-semibold small">Namespace</label>';
        html += `<div class="current-value-display">${escapeHtml(valuesToShow.namespace || 'default')}</div>`;
        html += '</div>';
        
        // Name Prefix - always show (even if empty to maintain alignment)
        html += '<div class="col-12">';
        html += '<label class="form-label fw-semibold small">Name Prefix</label>';
        html += `<div class="current-value-display">${valuesToShow.namePrefix ? escapeHtml(valuesToShow.namePrefix) : '<span style="color: var(--accent3);">—</span>'}</div>`;
        html += '</div>';
        
        // Replicas - always show
        html += '<div class="col-12">';
        html += '<label class="form-label fw-semibold small">Replicas</label>';
        html += `<div class="current-value-display">${escapeHtml(String(valuesToShow.replicas || 1))}</div>`;
        html += '</div>';
        
        // Image Tag - always show (even if empty)
        html += '<div class="col-12">';
        html += '<label class="form-label fw-semibold small">Image Tag</label>';
        html += `<div class="current-value-display">${valuesToShow.imageTag ? escapeHtml(valuesToShow.imageTag) : '<span style="color: var(--accent3);">—</span>'}</div>`;
        html += '</div>';
        
        // Storage Size - always show (even if empty)
        html += '<div class="col-12">';
        html += '<label class="form-label fw-semibold small">Storage Size</label>';
        html += `<div class="current-value-display">${valuesToShow.storageSize ? escapeHtml(valuesToShow.storageSize) : '<span style="color: var(--accent3);">—</span>'}</div>`;
        html += '</div>';
        
        html += '</div>';
        
        // Resource Requests section - match left column structure exactly
        html += '<div class="mt-4 pt-3 border-top">';
        html += '<h6 class="mb-3 fw-bold">Resource Requests</h6>';
        html += '<div class="row g-3">';
        
        // Memory
        html += '<div class="col-12">';
        html += '<label class="form-label fw-semibold small">Memory</label>';
        html += `<div class="current-value-display">${valuesToShow.resources && valuesToShow.resources.requests && valuesToShow.resources.requests.memory ? escapeHtml(valuesToShow.resources.requests.memory) : '<span style="color: var(--accent3);">—</span>'}</div>`;
        html += '</div>';
        
        // CPU
        html += '<div class="col-12">';
        html += '<label class="form-label fw-semibold small">CPU</label>';
        html += `<div class="current-value-display">${valuesToShow.resources && valuesToShow.resources.requests && valuesToShow.resources.requests.cpu ? escapeHtml(valuesToShow.resources.requests.cpu) : '<span style="color: var(--accent3);">—</span>'}</div>`;
        html += '</div>';
        
        html += '</div>';
        html += '</div>';
        
        // Resource Limits section - match left column structure exactly
        html += '<div class="mt-4 pt-3 border-top">';
        html += '<h6 class="mb-3 fw-bold">Resource Limits</h6>';
        html += '<div class="row g-3">';
        
        // Memory
        html += '<div class="col-12">';
        html += '<label class="form-label fw-semibold small">Memory</label>';
        html += `<div class="current-value-display">${valuesToShow.resources && valuesToShow.resources.limits && valuesToShow.resources.limits.memory ? escapeHtml(valuesToShow.resources.limits.memory) : '<span style="color: var(--accent3);">—</span>'}</div>`;
        html += '</div>';
        
        // CPU
        html += '<div class="col-12">';
        html += '<label class="form-label fw-semibold small">CPU</label>';
        html += `<div class="current-value-display">${valuesToShow.resources && valuesToShow.resources.limits && valuesToShow.resources.limits.cpu ? escapeHtml(valuesToShow.resources.limits.cpu) : '<span style="color: var(--accent3);">—</span>'}</div>`;
        html += '</div>';
        
        html += '</div>';
        html += '</div>';
        
        container.innerHTML = html;
        
        // Pre-fill override inputs with current values (deployed if deployed, merged if not)
        populateOverrideInputs(serviceName, valuesToShow);
    }
    
    function populateOverrideInputs(serviceName, values) {
        if (!values) return;
        
        // Set namespace
        const namespaceInput = document.querySelector(`input[name="services.${serviceName}.namespace"]`);
        if (namespaceInput && values.namespace) {
            namespaceInput.value = values.namespace;
        }
        
        // Set name prefix
        const namePrefixInput = document.querySelector(`input[name="services.${serviceName}.namePrefix"]`);
        if (namePrefixInput && values.namePrefix) {
            namePrefixInput.value = values.namePrefix;
        }
        
        // Set replicas
        const replicasInput = document.querySelector(`input[name="services.${serviceName}.replicas"]`);
        if (replicasInput && values.replicas) {
            replicasInput.value = values.replicas;
        }
        
        // Set image tag
        const imageTagInput = document.querySelector(`input[name="services.${serviceName}.imageTag"]`);
        if (imageTagInput && values.imageTag) {
            imageTagInput.value = values.imageTag;
        }
        
        // Set storage size
        const storageSizeInput = document.querySelector(`input[name="services.${serviceName}.storageSize"]`);
        if (storageSizeInput && values.storageSize) {
            storageSizeInput.value = values.storageSize;
        }
        
        // Set resource requests
        if (values.resources && values.resources.requests) {
            const memoryInput = document.querySelector(`input[name="services.${serviceName}.resources.requests.memory"]`);
            if (memoryInput && values.resources.requests.memory) {
                memoryInput.value = values.resources.requests.memory;
            }
            const cpuInput = document.querySelector(`input[name="services.${serviceName}.resources.requests.cpu"]`);
            if (cpuInput && values.resources.requests.cpu) {
                cpuInput.value = values.resources.requests.cpu;
            }
        }
        
        // Set resource limits
        if (values.resources && values.resources.limits) {
            const memoryInput = document.querySelector(`input[name="services.${serviceName}.resources.limits.memory"]`);
            if (memoryInput && values.resources.limits.memory) {
                memoryInput.value = values.resources.limits.memory;
            }
            const cpuInput = document.querySelector(`input[name="services.${serviceName}.resources.limits.cpu"]`);
            if (cpuInput && values.resources.limits.cpu) {
                cpuInput.value = values.resources.limits.cpu;
            }
        }
    }
    
    // Load parameters on page load (for refreshing after saves)
    // Note: Initial values are rendered server-side, this is mainly for refresh
    async function loadParameters() {
        try {
            const response = await fetch('/api/parameters');
            if (!response.ok) {
                throw new Error('Failed to load parameters');
            }
            const data = await response.json();
            
            // Populate all inputs dynamically (works with server-rendered inputs)
            function setNestedInputs(prefix, obj) {
                for (const [key, value] of Object.entries(obj)) {
                    const inputName = `${prefix}.${key}`;
                    if (typeof value === 'object' && value !== null && !Array.isArray(value)) {
                        setNestedInputs(inputName, value);
                    } else {
                        const inputs = document.querySelectorAll(`[name="${inputName}"], [name^="${inputName}["]`);
                        inputs.forEach(input => {
                            if (input.type === 'checkbox') {
                                input.checked = !!value;
                            } else {
                                input.value = value !== null && value !== undefined ? String(value) : '';
                            }
                        });
                    }
                }
            }
            
            // Populate global defaults
            if (data.global) {
                setNestedInputs('global', data.global);
            }
            
            // Populate service overrides
            if (data.services) {
                for (const [serviceName, serviceParams] of Object.entries(data.services)) {
                    setNestedInputs(`services.${serviceName}`, serviceParams);
                }
            }
        } catch (error) {
            console.error('Error loading parameters:', error);
            showParametersStatus('Error loading parameters: ' + error.message, 'error');
        }
    }
    
    function getNestedValue(obj, path) {
        return path.split('.').reduce((current, key) => current && current[key], obj);
    }
    
    // Update toggle button text based on collapse state and load current values when expanded
    document.querySelectorAll('[data-bs-toggle="collapse"]').forEach(btn => {
        const targetId = btn.getAttribute('data-bs-target');
        const target = document.querySelector(targetId);
        const text = btn.querySelector('.toggle-text');
        
        if (target) {
            target.addEventListener('show.bs.collapse', function() {
                if (text) {
                    // Check if this is the global advanced section
                    if (targetId === '#global-advanced') {
                        text.textContent = 'HIDE MORE';
                    } else {
                        text.textContent = 'HIDE';
                    }
                }
                // Update badges when service section is expanded (not for global advanced)
                if (targetId !== '#global-advanced') {
                    loadCurrentValues();
                }
            });
            target.addEventListener('hide.bs.collapse', function() {
                if (text) {
                    // Check if this is the global advanced section
                    if (targetId === '#global-advanced') {
                        text.textContent = 'SHOW MORE';
                    } else {
                        text.textContent = 'CONFIGURE';
                    }
                }
            });
        }
    });
    
    // Form submission
    document.getElementById('parameters-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const btn = document.getElementById('btn-save-parameters');
        const originalText = btn.textContent;
        btn.disabled = true;
        btn.textContent = 'Saving...';
        
        try {
            // Build request object from form data
            const formData = new FormData(this);
            const data = {
                global: {},
                services: {}
            };
            
            // Process global fields
            for (const [key, value] of formData.entries()) {
                if (key.startsWith('global.')) {
                    const path = key.replace('global.', '').split('.');
                    setNestedValue(data.global, path, value);
                } else if (key.startsWith('services.')) {
                    const parts = key.replace('services.', '').split('.');
                    const serviceName = parts[0];
                    const fieldPath = parts.slice(1);
                    
                    if (!data.services[serviceName]) {
                        data.services[serviceName] = {};
                    }
                    setNestedValue(data.services[serviceName], fieldPath, value);
                }
            }
            
            // Remove empty values
            cleanObject(data.global);
            for (const serviceName in data.services) {
                cleanObject(data.services[serviceName]);
                if (Object.keys(data.services[serviceName]).length === 0) {
                    delete data.services[serviceName];
                }
            }
            
            const response = await fetch('/api/parameters', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            });
            
            const result = await response.json();
            
            if (response.ok) {
                showParametersStatus('Parameters saved successfully!', 'success');
            } else {
                showParametersStatus('Error: ' + (result.error || 'Unknown error'), 'error');
            }
        } catch (error) {
            showParametersStatus('Error: ' + error.message, 'error');
        } finally {
            btn.disabled = false;
            btn.textContent = originalText;
        }
    });
    
    // Reset to defaults
    document.getElementById('btn-reset-parameters').addEventListener('click', function() {
        showConfirmModal('Reset all parameters to defaults?', function() {
            document.getElementById('parameters-form').reset();
            document.getElementById('global-namespace').value = 'default';
            document.getElementById('global-replicas').value = '1';
            loadParameters();
        });
    });
    
    function setNestedValue(obj, path, value) {
        if (value === '' || value === null) return;
        
        const lastKey = path[path.length - 1];
        const parent = path.slice(0, -1).reduce((current, key) => {
            if (!current[key]) current[key] = {};
            return current[key];
        }, obj);
        
        // Convert numeric fields to numbers
        if (lastKey === 'replicas' && value !== '') {
            const numValue = parseInt(value, 10);
            if (!isNaN(numValue)) {
                parent[lastKey] = numValue;
                return;
            }
        }
        
        parent[lastKey] = value;
    }
    
    function cleanObject(obj) {
        for (const key in obj) {
            if (obj[key] === '' || obj[key] === null || obj[key] === undefined) {
                delete obj[key];
            } else if (typeof obj[key] === 'object' && !Array.isArray(obj[key])) {
                cleanObject(obj[key]);
                if (Object.keys(obj[key]).length === 0) {
                    delete obj[key];
                }
            }
        }
    }
    
    function showParametersStatus(message, type) {
        const statusDiv = document.getElementById('parameters-status');
        statusDiv.className = `status-message ${type}`;
        statusDiv.textContent = message;
        statusDiv.style.display = 'block';
        
        setTimeout(() => {
            statusDiv.style.display = 'none';
        }, 5000);
    }
    
    // Update badges when page loads (values are already rendered server-side)
    loadCurrentValues();
})();
</script>
{{end}}

{{/* Recursive template functions for dynamic parameter rendering */}}

{{/* Render a single parameter input field */}}
{{define "render-param-input"}}
{{$key := .Key}}
{{$value := .Value}}
{{$prefix := .Prefix}}
{{$level := .Level | default 0}}
{{$fieldName := printf "%s.%s" $prefix $key}}
{{$fieldId := printf "%s-%s" $prefix $key | replace "." "-" | replace "[" "-" | replace "]" ""}}

{{/* Check if value is a string type marker from schema (e.g., "string", "number", "boolean") */}}
{{if isString $value}}
{{if or (eq $value "string") (eq $value "number") (eq $value "integer") (eq $value "boolean")}}
{{/* This is a schema type marker - render as empty input */}}
<div class="col-12">
    <label for="{{$fieldId}}" class="form-label fw-semibold small">{{$key | title}}</label>
    <input type="{{if eq $value "number"}}number{{else if eq $value "boolean"}}checkbox{{else}}text{{end}}" class="form-control form-control-sm" id="{{$fieldId}}" name="{{$fieldName}}" value="" placeholder="">
</div>
{{else}}
{{/* Regular string value */}}
<div class="col-12">
    <label for="{{$fieldId}}" class="form-label fw-semibold small">{{$key | title}}</label>
    <input type="text" class="form-control form-control-sm" id="{{$fieldId}}" name="{{$fieldName}}" value="{{$value}}" placeholder="">
</div>
{{end}}
{{else if isBool $value}}
<div class="col-12">
    <div class="form-check">
        <input type="checkbox" class="form-check-input" id="{{$fieldId}}" name="{{$fieldName}}" {{if $value}}checked{{end}}>
        <label class="form-check-label form-label fw-semibold small" for="{{$fieldId}}">{{$key | title}}</label>
    </div>
</div>
{{else if isNumber $value}}
<div class="col-12">
    <label for="{{$fieldId}}" class="form-label fw-semibold small">{{$key | title}}</label>
    <input type="number" class="form-control form-control-sm" id="{{$fieldId}}" name="{{$fieldName}}" value="{{$value}}" step="any">
</div>
{{else if isMap $value}}
{{if eq (len $value) 0}}
{{/* Empty map - render as empty input field */}}
<div class="col-12">
    <label for="{{$fieldId}}" class="form-label fw-semibold small">{{$key | title}}</label>
    <input type="text" class="form-control form-control-sm" id="{{$fieldId}}" name="{{$fieldName}}" value="" placeholder="">
</div>
{{else}}
<div class="col-12">
    <div class="border rounded p-3 mt-2" style="margin-left: {{mul $level 20}}px;">
        <h6 class="mb-2 fw-bold">{{$key | title}}</h6>
        <div class="row g-3">
            {{range $k, $v := $value}}
            {{template "render-param-input" (dict "Key" $k "Value" $v "Prefix" $fieldName "Level" (add $level 1))}}
            {{end}}
        </div>
    </div>
</div>
{{end}}
{{else if isSlice $value}}
<div class="col-12">
    <label class="form-label fw-semibold small">{{$key | title}} (Array)</label>
    <div class="border rounded p-3 mt-2" style="margin-left: {{mul $level 20}}px;">
        {{range $i, $v := $value}}
        <div class="mb-2">
            {{if isMap $v}}
            {{template "render-param-input" (dict "Key" (printf "%s[%d]" $key $i) "Value" $v "Prefix" $prefix "Level" (add $level 1))}}
            {{else}}
            <input type="text" class="form-control form-control-sm" name="{{$fieldName}}[{{$i}}]" value="{{$v}}">
            {{end}}
        </div>
        {{end}}
    </div>
</div>
{{else}}
<div class="col-12">
    <label for="{{$fieldId}}" class="form-label fw-semibold small">{{$key | title}}</label>
    <input type="text" class="form-control form-control-sm" id="{{$fieldId}}" name="{{$fieldName}}" value="{{$value}}" placeholder="">
</div>
{{end}}
{{end}}

{{/* Render a group of parameters (object) */}}
{{define "render-param-group"}}
{{$params := .Params}}
{{$prefix := .Prefix}}
{{$level := .Level | default 0}}
{{range $k, $v := $params}}
{{template "render-param-input" (dict "Key" $k "Value" $v "Prefix" $prefix "Level" $level)}}
{{end}}
{{end}}

{{/* Render parameter display (read-only) */}}
{{define "render-param-display"}}
{{$key := .Key}}
{{$value := .Value}}
{{$level := .Level | default 0}}

{{if isBool $value}}
<div class="col-12">
    <label class="form-label fw-semibold small">{{$key | title}}</label>
    <div class="current-value-display">{{if $value}}true{{else}}false{{end}}</div>
</div>
{{else if isMap $value}}
<div class="col-12">
    <div class="border rounded p-3 mt-2" style="margin-left: {{mul $level 20}}px;">
        <h6 class="mb-2 fw-bold">{{$key | title}}</h6>
        <div class="row g-3">
            {{range $k, $v := $value}}
            {{template "render-param-display" (dict "Key" $k "Value" $v "Level" (add $level 1))}}
            {{end}}
        </div>
    </div>
</div>
{{else if isSlice $value}}
<div class="col-12">
    <label class="form-label fw-semibold small">{{$key | title}}</label>
    <div class="current-value-display">
        {{range $i, $v := $value}}{{if $i}}, {{end}}{{$v}}{{end}}
    </div>
</div>
{{else}}
<div class="col-12">
    <label class="form-label fw-semibold small">{{$key | title}}</label>
    <div class="current-value-display">{{if $value}}{{$value}}{{else}}<span style="color: var(--accent3);">—</span>{{end}}</div>
</div>
{{end}}
{{end}}

{{/* Render a group of parameters for display (read-only) */}}
{{define "render-param-display-group"}}
{{$params := .Params}}
{{$level := .Level | default 0}}
{{range $k, $v := $params}}
{{template "render-param-display" (dict "Key" $k "Value" $v "Level" $level)}}
{{end}}
{{end}}

