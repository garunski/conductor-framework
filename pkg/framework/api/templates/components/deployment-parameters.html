{{define "deployment-parameters"}}
<div class="card mb-4">
    <div class="card-header">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h2>Deployment Parameters</h2>
                <p class="card-description mb-0">Configure deployment settings for all services</p>
            </div>
            <div class="d-flex gap-2">
                <button type="submit" form="parameters-form" class="btn btn-sm" id="btn-save-parameters">SAVE</button>
                <button type="button" class="btn btn-sm btn-secondary" id="btn-reset-parameters">RESET</button>
            </div>
        </div>
    </div>
    
    <div class="card-body p-0">
        <form id="parameters-form">
            <!-- Editor-First Layout with Slide-Out Schema Panel -->
            <div style="position: relative; min-height: 600px;">
                <!-- Main Editor Area -->
                <div id="editor-container" style="transition: margin-right 0.3s ease; min-height: 600px;">
                    <div class="d-flex flex-column" style="height: 100%; min-height: 600px;">
                        <!-- Editor Header -->
                        <div class="p-3 border-bottom bg-light">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-0 fw-bold">YAML Editor</h6>
                                    <small class="text-muted">Edit deployment parameters</small>
                                </div>
                                <div class="d-flex gap-2">
                                    <button type="button" class="btn btn-sm btn-outline-info" id="btn-view-deployed" title="View deployed values">
                                        <span>üëÅÔ∏è</span> View Deployed
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-secondary" id="btn-schema-toggle">
                                        <span>üìñ</span> Schema
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-primary" id="btn-validate-yaml">Validate</button>
                                    <button type="button" class="btn btn-sm btn-outline-secondary" id="btn-diff-yaml">Diff</button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Editor -->
                        <div class="flex-grow-1" style="position: relative; min-height: 500px;">
                            <div id="yaml-editor" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; width: 100%; height: 100%;"></div>
                        </div>
                        
                        <!-- Status Bar -->
                        <div class="p-2 border-top bg-light">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <div id="yaml-validation-status" class="small"></div>
                                    <div id="current-state-indicator" class="small text-muted mt-1"></div>
                                </div>
                                <div id="yaml-diff-summary" class="small text-muted"></div>
                                <div class="d-flex gap-2">
                                    <button type="button" class="btn btn-sm btn-secondary" id="btn-reset-yaml">Reset</button>
                                    <button type="submit" form="parameters-form" class="btn btn-sm" id="btn-apply-yaml">Apply</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Slide-Out Schema Panel -->
                <div id="schema-panel" class="schema-panel">
                    <div class="d-flex flex-column h-100" style="background-color: #f8f9fa; border-left: 1px solid #dee2e6;">
                        <!-- Schema Panel Header -->
                        <div class="p-3 border-bottom bg-white">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h6 class="mb-0 fw-bold">Schema Reference</h6>
                                <button type="button" class="btn btn-sm btn-link text-decoration-none p-0" id="btn-schema-close" title="Close (Esc)">
                                    <span>‚úï</span>
                                </button>
                            </div>
                            <input type="text" class="form-control form-control-sm" id="schema-search" placeholder="üîç Search fields...">
                            <small class="text-muted">Press Ctrl+K to focus search</small>
                        </div>
                        
                        <!-- Schema Content -->
                        <div id="schema-explorer" class="flex-grow-1" style="overflow-y: auto; padding: 1rem;">
                            <div class="text-muted text-center py-5">
                                <div class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></div>
                                <span class="small">Loading schema...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="parameters-status" class="p-3 border-top"></div>
        </form>
    </div>
    
    <style>
        .schema-panel {
            position: fixed;
            top: 0;
            right: 0;
            width: 35%;
            max-width: 500px;
            height: 100vh;
            z-index: 1050;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            box-shadow: -2px 0 8px rgba(0,0,0,0.1);
        }
        
        .schema-panel.open {
            transform: translateX(0);
        }
        
        .editor-with-schema {
            margin-right: 35%;
        }
        
        .schema-field-item {
            padding: 6px 8px;
            border-radius: 4px;
            margin: 2px 0;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .schema-field-item:hover {
            background-color: #e9ecef;
        }
        
        .schema-field-item.active {
            background-color: #cfe2ff;
            border-left: 3px solid #0d6efd;
        }
        
        .schema-field-item.selected {
            background-color: #b3d7ff;
            font-weight: 600;
        }
        
        @media (max-width: 768px) {
            .schema-panel {
                width: 90%;
                max-width: none;
            }
        }
    </style>
</div>

<!-- Confirmation Modal -->
<div class="modal fade" id="confirm-modal" tabindex="-1" aria-labelledby="confirm-modal-label" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content custom-modal">
            <div class="modal-header">
                <h5 class="modal-title" id="confirm-modal-label">Confirm Action</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p id="confirm-modal-message"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="confirm-modal-cancel" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn" id="confirm-modal-confirm">Confirm</button>
            </div>
        </div>
    </div>
</div>

<!-- Load Ace Editor from CDN -->
<script src="https://cdn.jsdelivr.net/npm/ace-builds@1.32.0/src-noconflict/ace.js"></script>
<script src="https://cdn.jsdelivr.net/npm/ace-builds@1.32.0/src-noconflict/mode-yaml.js"></script>
<script src="https://cdn.jsdelivr.net/npm/ace-builds@1.32.0/src-noconflict/theme-github.js"></script>
<script src="https://cdn.jsdelivr.net/npm/ace-builds@1.32.0/src-noconflict/ext-language_tools.js"></script>
<script src="https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js"></script>

<!-- Load JavaScript modules -->
<script src="/static/js/deployment-parameters.js?t={{.CacheBust}}"></script>

<script>
    // Initialize deployment parameters page when DOM is ready
    document.addEventListener('DOMContentLoaded', function() {
        if (typeof window.deploymentParams !== 'undefined' && window.deploymentParams.init) {
            const servicesJSON = {{.Services | json | safeJS}};
            
            // Fetch parameters from API endpoint
            fetch('/api/parameters')
                .then(r => r.json())
                .then(instanceSpec => {
                    console.log('Fetched parameters from API');
                    window.deploymentParams.init(instanceSpec, servicesJSON);
                })
                .catch(error => {
                    console.error('Failed to fetch parameters:', error);
                    // Fallback to empty data
                    window.deploymentParams.init({}, servicesJSON);
                });
        } else {
            console.error('Deployment parameters module not loaded');
        }
    });
</script>
{{end}}

{{/* Render parameter display (read-only) */}}
{{define "render-param-display"}}
{{$key := .Key}}
{{$value := .Value}}
{{$level := .Level | default 0}}

{{if isBool $value}}
<div class="col-12">
    <label class="form-label fw-semibold small">{{$key | title}}</label>
    <div class="current-value-display">{{if $value}}true{{else}}false{{end}}</div>
</div>
{{else if isMap $value}}
<div class="col-12">
    <div class="border rounded p-3 mt-2" style="margin-left: {{mul $level 20}}px;">
        <h6 class="mb-2 fw-bold">{{$key | title}}</h6>
        <div class="row g-3">
            {{range $k, $v := $value}}
            {{template "render-param-display" (dict "Key" $k "Value" $v "Level" (add $level 1))}}
            {{end}}
        </div>
    </div>
</div>
{{else if isSlice $value}}
<div class="col-12">
    <label class="form-label fw-semibold small">{{$key | title}}</label>
    <div class="current-value-display">
        {{range $i, $v := $value}}{{if $i}}, {{end}}{{$v}}{{end}}
    </div>
</div>
{{else}}
<div class="col-12">
    <label class="form-label fw-semibold small">{{$key | title}}</label>
    <div class="current-value-display">{{if $value}}{{$value}}{{else}}<span style="color: var(--accent3);">‚Äî</span>{{end}}</div>
</div>
{{end}}
{{end}}

{{/* Render a group of parameters for display (read-only) */}}
{{define "render-param-display-group"}}
{{$params := .Params}}
{{$level := .Level | default 0}}
{{range $k, $v := $params}}
{{template "render-param-display" (dict "Key" $k "Value" $v "Level" $level)}}
{{end}}
{{end}}
