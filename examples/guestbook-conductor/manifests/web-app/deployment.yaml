apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{if .Spec.Global.namePrefix}}{{.Spec.Global.namePrefix}}{{end}}web-app
  namespace: {{if .Spec.Global.namespace}}{{.Spec.Global.namespace}}{{else}}default{{end}}
spec:
  {{- $webApp := getService "web-app"}}
  replicas: {{if $webApp}}{{if $webApp.replicas}}{{$webApp.replicas}}{{else if .Spec.Global.replicas}}{{.Spec.Global.replicas}}{{else}}1{{end}}{{else if .Spec.Global.replicas}}{{.Spec.Global.replicas}}{{else}}1{{end}}
  selector:
    matchLabels:
      app: {{if .Spec.Global.namePrefix}}{{.Spec.Global.namePrefix}}{{end}}web-app
  template:
    metadata:
      labels:
        app: {{if .Spec.Global.namePrefix}}{{.Spec.Global.namePrefix}}{{end}}web-app
    spec:
      {{- if .Spec.Global.imagePullSecrets}}
      imagePullSecrets:
      {{- range .Spec.Global.imagePullSecrets}}
      - name: {{.name}}
      {{- end}}
      {{- end}}
      containers:
      - name: web-app
        image: {{if .Spec.Global.imageRegistry}}{{.Spec.Global.imageRegistry}}/{{end}}web-app:{{if $webApp}}{{if $webApp.imageTag}}{{$webApp.imageTag}}{{else if .Spec.Global.imageTag}}{{.Spec.Global.imageTag}}{{else}}latest{{end}}{{else if .Spec.Global.imageTag}}{{.Spec.Global.imageTag}}{{else}}latest{{end}}
        ports:
        - containerPort: 3000
          name: http
        env:
        {{- if $webApp}}
        {{- if $webApp.config}}
        - name: API_ENDPOINT
          value: {{if $webApp.config.apiEndpoint}}{{$webApp.config.apiEndpoint}}{{else}}http://api-service:8080{{end}}
        {{- if $webApp.config.features}}
        - name: ENABLE_SSO
          value: {{if $webApp.config.features.sso}}{{$webApp.config.features.sso | toString}}{{else}}"false"{{end}}
        {{- end}}
        {{- end}}
        {{- end}}
        resources:
          requests:
            memory: {{if $webApp}}{{if and $webApp.resources $webApp.resources.requests $webApp.resources.requests.memory}}{{$webApp.resources.requests.memory}}{{else if and .Spec.Global.resources .Spec.Global.resources.requests .Spec.Global.resources.requests.memory}}{{.Spec.Global.resources.requests.memory}}{{else}}"64Mi"{{end}}{{else if and .Spec.Global.resources .Spec.Global.resources.requests .Spec.Global.resources.requests.memory}}{{.Spec.Global.resources.requests.memory}}{{else}}"64Mi"{{end}}
            cpu: {{if $webApp}}{{if and $webApp.resources $webApp.resources.requests $webApp.resources.requests.cpu}}{{$webApp.resources.requests.cpu}}{{else if and .Spec.Global.resources .Spec.Global.resources.requests .Spec.Global.resources.requests.cpu}}{{.Spec.Global.resources.requests.cpu}}{{else}}"100m"{{end}}{{else if and .Spec.Global.resources .Spec.Global.resources.requests .Spec.Global.resources.requests.cpu}}{{.Spec.Global.resources.requests.cpu}}{{else}}"100m"{{end}}
          limits:
            memory: {{if $webApp}}{{if and $webApp.resources $webApp.resources.limits $webApp.resources.limits.memory}}{{$webApp.resources.limits.memory}}{{else if and .Spec.Global.resources .Spec.Global.resources.limits .Spec.Global.resources.limits.memory}}{{.Spec.Global.resources.limits.memory}}{{else}}"128Mi"{{end}}{{else if and .Spec.Global.resources .Spec.Global.resources.limits .Spec.Global.resources.limits.memory}}{{.Spec.Global.resources.limits.memory}}{{else}}"128Mi"{{end}}
            cpu: {{if $webApp}}{{if and $webApp.resources $webApp.resources.limits $webApp.resources.limits.cpu}}{{$webApp.resources.limits.cpu}}{{else if and .Spec.Global.resources .Spec.Global.resources.limits .Spec.Global.resources.limits.cpu}}{{.Spec.Global.resources.limits.cpu}}{{else}}"200m"{{end}}{{else if and .Spec.Global.resources .Spec.Global.resources.limits .Spec.Global.resources.limits.cpu}}{{.Spec.Global.resources.limits.cpu}}{{else}}"200m"{{end}}

